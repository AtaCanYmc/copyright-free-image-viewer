<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Explorer - Project Assets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .folder-content {
            transition: all 0.3s ease-in-out;
        }
    </style>

    <script>
        function toggleNode(el) {
            const content = el.nextElementSibling;
            if (content && content.classList.contains('folder-content')) {
                content.classList.toggle('hidden');
                if (!content.classList.contains('hidden')) {
                    el.classList.add('bg-indigo-50/50');
                } else {
                    el.classList.remove('bg-indigo-50/50');
                }
            }
        }

        async function runAction(event, action) {
            if (event) {
                event.preventDefault();
            }

            const btn = event ? event.currentTarget : null;
            const originalText = btn ? btn.innerHTML : '';

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            }

            try {
                let url = '';
                let method = 'POST';

                if (action === 'convert-webp') {
                    url = '/explorer/actions/convert-webp';
                } else if (action.startsWith('refetch-')) {
                    const source = action.split('-')[1];
                    url = `/explorer/actions/refetch/${source}`;
                } else if (action === 'remove-all') { // Legacy internal name for images
                    url = '/explorer/actions/delete-images';
                } else if (action === 'remove-db') {
                    url = '/explorer/actions/delete-db';
                } else if (action === 'convert-db-json') {
                    url = '/explorer/actions/convert-db-json';
                } else if (action === 'convert-db-csv') {
                    url = '/explorer/actions/convert-db-csv';
                }

                if (!url) {
                    throw new Error(`Invalid action: ${action}`);
                }

                // Show Overlay
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                }

                const response = await fetch(url, { method: method });

                // Check if response is JSON
                const contentType = response.headers.get("content-type");
                let data;
                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    // If not JSON, probably an HTML error page (500, 404, etc.)
                    const text = await response.text();
                    throw new Error(`Server returned non-JSON response: ${response.status} ${response.statusText}.`);
                }

                if (response.ok) {
                    // Determine style based on success
                    alert(`Success: ${data.message}`);
                    window.location.reload();
                } else {
                    alert(`Error: ${data.message}`);
                    if (overlay) {
                        overlay.classList.add('hidden'); // Hide only on error if we are not reloading
                        overlay.classList.remove('flex');
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                alert(`An error occurred: ${error.message}`);

                // Hide overlay on error
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                }
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }

        function confirmDeleteAll(event, type) {
            let msg = "Are you sure?";
            let action = "";

            if (type === 'images') {
                msg = "DANGER: This will delete all images in the project folder. Are you sure?";
                action = 'remove-all';
            } else if (type === 'json') {
                msg = "This will delete all JSON data in the project database. Are you sure?";
                action = 'remove-db';
            }

            if (confirm(msg)) {
                runAction(event, action);
            }
        }
    </script>
</head>

<body class="bg-gray-50 text-gray-900 antialiased">

    <nav class="bg-white border-b border-gray-200 px-6 py-4 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-8">
                <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                        <circle cx="9" cy="9" r="2" />
                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                    </svg>
                    Explorer
                </h1>
                <div class="hidden md:flex items-center bg-gray-100 p-1 rounded-xl">
                    {% for page in pages %}
                    <a href="{{ page.route }}"
                        class="px-4 py-2 rounded-lg text-sm font-semibold transition-all {% if request.path == page.route %} bg-white text-indigo-600 shadow-sm {% else %} text-gray-500 hover:text-gray-900 {% endif %}">
                        {{ page.name | capitalize }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 md:p-12">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-10">
            <div>
                <h2 class="text-3xl font-extrabold text-gray-900 tracking-tight">Project Explorer</h2>
                <p class="text-gray-500 mt-1">Browse the physical directory structure and manage assets.</p>
            </div>
            <div class="flex gap-2">
                <div class="px-4 py-2 bg-indigo-50 border border-indigo-100 rounded-xl flex items-center gap-2">
                    <span class="text-xs font-bold text-indigo-700 uppercase">Project: {{ project_name }}</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            <div class="lg:col-span-2 bg-white rounded-3xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6 border-b border-gray-100 bg-gray-50/30">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-gray-400">File Hierarchy</h3>
                </div>

                <div class="p-4">
                    {% macro render_node(node, depth=0) %}
                    <div class="select-none">
                        <div class="group flex items-center justify-between py-3 px-4 rounded-2xl hover:bg-indigo-50/50 transition-colors cursor-pointer"
                            {% if node.type=='folder' %} onclick="toggleNode(this)" {% endif %}>

                            <div class="flex items-center gap-3" style="margin-left:  depth * 1.5 }}rem;">
                                <div
                                    class="w-8 h-8 rounded-lg flex items-center justify-center {% if node.type == 'folder' %} bg-amber-50 text-amber-500 {% else %} bg-blue-50 text-blue-500 {% endif %}">
                                    {% if node.type == 'folder' %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="folder-icon">
                                        <path
                                            d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z" />
                                    </svg>
                                    {% else %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path
                                            d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                                        <polyline points="14.5 2 14.5 7 20 7" />
                                    </svg>
                                    {% endif %}
                                </div>
                                <span
                                    class="{% if node.type == 'folder' %} font-bold text-gray-700 {% else %} text-gray-600 {% endif %} text-sm mono">
                                    {{ node.name }}{% if node.type == 'folder' %}/{% endif %}
                                </span>
                            </div>

                            <div class="flex items-center gap-4">
                                <span
                                    class="text-xs font-semibold px-2 py-1 rounded-md {% if node.type == 'folder' %} bg-gray-100 text-gray-500 {% else %} bg-indigo-50 text-indigo-600 {% endif %}">
                                    {{ node.type | capitalize }}
                                </span>
                            </div>
                        </div>

                        {% if node.children %}
                        <div class="hidden folder-content border-l border-gray-100 ml-8 my-1">
                            {% for child in node.children %}
                            {{ render_node(child, depth + 1) }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endmacro %}

                    {{ render_node(tree_data) }}
                </div>
            </div>
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-3xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-indigo-500">
                            <path d="M12 2v4" />
                            <path d="m16.2 7.8 2.9-2.9" />
                            <path d="M18 12h4" />
                            <path d="m16.2 16.2 2.9 2.9" />
                            <path d="M12 18v4" />
                            <path d="m4.9 19.1 2.9-2.9" />
                            <path d="M2 12h4" />
                            <path d="m4.9 4.9 2.9 2.9" />
                        </svg>
                        Maintenance Actions
                    </h3>

                    <div class="space-y-3">
                        <button type="button" onclick="runAction(event, 'convert-webp')"
                            class="w-full flex items-center justify-between px-4 py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-2xl transition-all group">
                            <span class="text-sm font-semibold">Convert Images to WebP</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="group-hover:translate-x-1 transition-transform">
                                <path d="m9 18 6-6-6-6" />
                            </svg>
                        </button>

                        <button type="button" onclick="runAction(event, 'convert-db-json')"
                            class="w-full flex items-center justify-between px-4 py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-2xl transition-all group">
                            <span class="text-sm font-semibold">Convert image data to JSON</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="group-hover:translate-x-1 transition-transform">
                                <path d="m9 18 6-6-6-6" />
                            </svg>
                        </button>

                        <button type="button" onclick="runAction(event, 'convert-db-csv')"
                            class="w-full flex items-center justify-between px-4 py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-2xl transition-all group">
                            <span class="text-sm font-semibold">Convert image data to CSV</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="group-hover:translate-x-1 transition-transform">
                                <path d="m9 18 6-6-6-6" />
                            </svg>
                        </button>

                        <div class="pt-2 space-y-2">
                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1 tracking-wider">Refetch
                                Images</p>
                            <button type="button" onclick="runAction(event, 'refetch-pexels')"
                                class="w-full flex items-center gap-3 px-4 py-2.5 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-xl text-sm font-medium transition-all">
                                <span class="w-2 h-2 bg-teal-400 rounded-full"></span> Pexels
                            </button>
                            <button type="button" onclick="runAction(event, 'refetch-pixabay')"
                                class="w-full flex items-center gap-3 px-4 py-2.5 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-xl text-sm font-medium transition-all">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full"></span> Pixabay
                            </button>
                            <button type="button" onclick="runAction(event, 'refetch-unsplash')"
                                class="w-full flex items-center gap-3 px-4 py-2.5 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-xl text-sm font-medium transition-all">
                                <span class="w-2 h-2 bg-black rounded-full"></span> Unsplash
                            </button>
                        </div>

                        <div class="pt-4 border-t border-gray-100">
                            <button type="button" onclick="confirmDeleteAll(event, 'images')"
                                class="w-full flex items-center gap-3 px-4 py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-2xl transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M3 6h18" />
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                    <line x1="10" x2="10" y1="11" y2="17" />
                                    <line x1="14" x2="14" y1="11" y2="17" />
                                </svg>
                                <span class="text-sm font-bold">Remove All Images</span>
                            </button>
                        </div>
                        <div class="pt-0">
                            <button type="button" onclick="confirmDeleteAll(event, 'json')"
                                class="w-full flex items-center gap-3 px-4 py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-2xl transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M3 6h18" />
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                    <line x1="10" x2="10" y1="11" y2="17" />
                                    <line x1="14" x2="14" y1="11" y2="17" />
                                </svg>
                                <span class="text-sm font-bold">Remove All Image Data</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-indigo-600 rounded-3xl p-6 text-white shadow-lg shadow-indigo-100">
                    <h4 class="text-xs font-bold text-indigo-200 uppercase tracking-widest mb-2">Live Tracking</h4>
                    <p class="text-sm leading-relaxed opacity-90">
                        This view represents the real-time file system inside your Docker container.
                    </p>
                </div>
            </div>
        </div>
    </main>
    <div id="loading-overlay"
        class="hidden fixed inset-0 bg-indigo-900/20 backdrop-blur-sm z-[100] flex items-center justify-center transition-all duration-300">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center">
            <div class="relative w-16 h-16">
                <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin">
                </div>
            </div>
            <p class="mt-4 text-indigo-900 font-bold tracking-tight">Processing...</p>
            <p class="text-xs text-gray-400 mt-1 italic">Please wait while we process your request</p>
        </div>
    </div>
</body>

</html>